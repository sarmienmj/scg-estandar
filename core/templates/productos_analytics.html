{% extends 'menu.html' %}
{% load static %}

{% block title %}Anal√≠ticas de Productos - SCG POS{% endblock title %}

{% block content %}
{% csrf_token %}
<style>
    :root {
        --primary-color: #001E62;
        --secondary-color: #418FDE;
        --success-color: #467012;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
    }
    
    .card {
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .metric-card {
        border-left: 4px solid var(--primary-color);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .metric-card.success {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #d1e7dd 0%, #badbcc 100%);
    }
    
    .metric-card.warning {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }
    
    .metric-card.danger {
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    }
    
    .metric-card.info {
        border-left-color: var(--secondary-color);
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    }
    
    .btn-group .btn.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .btn-group .btn:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: white;
    }
    
    #productosChartsContainer canvas {
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 30, 98, 0.1);
    }
    
    /* Estilos para el dropdown de b√∫squeda de productos */
    .producto-option {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }
    
    .producto-option:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .producto-option.selected {
        background-color: var(--secondary-color);
        color: white;
    }
    
    .producto-option:last-child {
        border-bottom: none;
    }
    
    .producto-nombre {
        font-weight: 500;
    }
    
    .producto-unidad {
        color: #666;
        font-size: 0.875rem;
    }
    
    .producto-option:hover .producto-unidad {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .producto-option.selected .producto-unidad {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Estilos para sugerencias de productos */
    .producto-sugerencia-titulo {
        background-color: #fff3cd;
        border-bottom: 1px solid #ffeaa7;
        font-size: 0.9em;
        color: #856404;
        cursor: default;
    }
    
    .producto-sugerencia-titulo:hover {
        background-color: #fff3cd !important;
        color: #856404 !important;
    }
    
    .producto-sugerencia {
        background-color: #f8f9fa;
        border-left: 3px solid #28a745;
    }
    
    .producto-sugerencia:hover {
        background-color: #e8f5e8 !important;
        color: #155724 !important;
    }
    
    .producto-sugerencia .producto-unidad {
        color: #28a745;
        font-weight: 500;
    }
    
    .producto-sugerencia:hover .producto-unidad {
        color: #155724 !important;
    }
    
    /* Asegurar que los cards de resumen se muestren correctamente */
    #resumenProducto .row {
        display: flex;
        flex-wrap: wrap;
    }
    
    #resumenProducto .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
    }
    
    /* Ajustes para tablets */
    @media (max-width: 991.98px) and (min-width: 768px) {
        #resumenProducto .col-md-4 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }
    }
    
    /* Responsive */
    @media (max-width: 767.98px) {
        #productosChartsContainer canvas,
        #movimientosChartsContainer canvas {
            max-height: 300px;
        }
        
        .container-fluid {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        
        /* Prevenir overflow horizontal */
        .card-body {
            padding: 1rem 0.5rem;
        }
        
        .btn-group {
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
        }
        
        /* Ajustar espaciado en m√≥vil */
        .d-flex.flex-wrap.gap-2 {
            gap: 0.25rem !important;
        }
        
        /* Ajustar filtro de fechas en m√≥vil */
        .d-flex.align-items-center.gap-2 {
            flex-direction: column;
            align-items: stretch !important;
            gap: 0.5rem !important;
        }
        
        .d-flex.align-items-center.gap-2 input[type="date"] {
            width: 100% !important;
        }
        
        /* Hacer que los botones se apilen en m√≥vil */
        .btn-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem !important;
            margin-bottom: 0.25rem;
        }
        
        /* Asegurar que los cards de resumen se apilen en m√≥vil */
        #resumenProducto .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
            margin-bottom: 1rem;
        }
        
        /* Ajustar m√©tricas en m√≥vil */
        .metric-card .card-body {
            padding: 0.75rem;
        }
        
        .metric-card h2,
        .metric-card h3 {
            font-size: 1.5rem;
        }
        
        .metric-card h6 {
            font-size: 0.875rem;
        }
        
        /* Ajustar selector de producto */
        #productoSelector,
        #productoSearch {
            font-size: 0.875rem;
        }
        
        /* Ajustar dropdown en m√≥vil */
        #productoDropdown {
            max-height: 150px;
        }
        
        .producto-option {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* Ajustar t√≠tulos */
        .display-4 {
            font-size: 2rem;
        }
        
        .lead {
            font-size: 1rem;
        }
    }
    
    /* Ajustes adicionales para pantallas muy peque√±as */
    @media (max-width: 575.98px) {
        .container-fluid {
            padding-left: 0.125rem;
            padding-right: 0.125rem;
        }
        
        .card-body {
            padding: 0.75rem 0.25rem;
        }
        
        .btn-group .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.375rem;
        }
        
        .metric-card h2,
        .metric-card h3 {
            font-size: 1.25rem;
        }
        
        .display-4 {
            font-size: 1.75rem;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 mb-0">üì¶ Anal√≠ticas de Productos</h1>
            <p class="lead text-muted">An√°lisis detallado del inventario y rendimiento de productos</p>
        </div>
    </div>

    <!-- M√©tricas Principales -->
    <div class="row mb-4">
        <!-- Total de Productos -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">üì¶ Total Productos</h6>
                            <h2 class="mb-0 text-primary">{{ total_productos }}</h2>
                            <small class="text-muted">Productos registrados</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-primary mb-1">Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos con Stock -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card success h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">‚úÖ Con Stock</h6>
                            <h2 class="mb-0 text-success">{{ productos_con_stock }}</h2>
                            <small class="text-muted">Disponibles</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-success mb-1">Stock</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos sin Stock -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card warning h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">‚ö†Ô∏è Sin Stock</h6>
                            <h2 class="mb-0 text-warning">{{ productos_sin_stock }}</h2>
                            <small class="text-muted">Agotados</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-warning text-dark mb-1">Agotado</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valor del Inventario -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card info h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">üí∞ Valor Inventario</h6>
                            <h2 class="mb-0 text-info">${{ valor_inventario_usd }}</h2>
                            <small class="text-muted">{{ valor_inventario_bs }} Bs.F</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-info mb-1">Valor</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√©tricas Secundarias -->
    <div class="row mb-4">
        <!-- Productos por Unidad -->
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card metric-card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">üìè Por Unidad</h6>
                            <h2 class="mb-0 text-primary">{{ productos_por_unidad }}</h2>
                            <small class="text-muted">Productos unitarios</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-primary mb-1">Unidad</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos por Kilo -->
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card metric-card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-1">‚öñÔ∏è Por Kilo</h6>
                            <h2 class="mb-0 text-primary">{{ productos_por_kilo }}</h2>
                            <small class="text-muted">Productos por peso</small>
                        </div>
                        <div class="text-right">
                            <div class="badge bg-primary mb-1">Kilo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Gr√°ficos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">üìä Productos M√°s Vendidos</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <!-- Filtros de fecha predefinidos -->
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-date-filter="7days">
                                        üìÖ √öltimos 7 d√≠as
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-date-filter="30days">
                                        üìÖ √öltimos 30 d√≠as
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-date-filter="90days">
                                        üìÖ √öltimos 90 d√≠as
                                    </button>
                                </div>
                                
                                <!-- Filtro de rango de fechas personalizado -->
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-muted">üìÖ</span>
                                    <input type="date" class="form-control form-control-sm" id="startDate" style="width: 140px;">
                                    <span class="text-muted">a</span>
                                    <input type="date" class="form-control form-control-sm" id="endDate" style="width: 140px;">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="applyDateRange">
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros de tipo de an√°lisis -->
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-success active" data-tipo="cantidad">
                                        üìè Por Cantidad
                                    </button>
                                    <button type="button" class="btn btn-outline-success" data-tipo="valor">
                                        üí∞ Por Valor
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros de unidad -->
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-info active" data-unidad="todas">
                                        üì¶ Todas las Unidades
                                    </button>
                                    <button type="button" class="btn btn-outline-info" data-unidad="U">
                                        üìè Solo Unidades
                                    </button>
                                    <button type="button" class="btn btn-outline-info" data-unidad="K">
                                        ‚öñÔ∏è Solo Kilos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenedor de Gr√°ficos -->
                    <div class="row" id="productosChartsContainer">
                        <!-- Los gr√°ficos se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Movimientos de Producto -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">üìà Movimientos de Producto</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <!-- Selector de Producto con B√∫squeda -->
                            <div class="mb-3">
                                <label for="productoSelector" class="form-label">üîç Seleccionar Producto:</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="productoSearch" placeholder="Buscar producto..." autocomplete="off">
                                    <select class="form-select" id="productoSelector" required style="display: none;">
                                        <option value="">-- Selecciona un producto --</option>
                                        {% for producto in productos_lista %}
                                        <option value="{{ producto.id }}" data-unidad="{{ producto.unidad }}" data-nombre="{{ producto.nombre|lower }}">
                                            {{ producto.nombre }} ({{ producto.unidad }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div id="productoDropdown" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; top: 100%;">
                                        <!-- Los resultados de b√∫squeda se cargar√°n aqu√≠ -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtros de fecha predefinidos -->
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-movimiento-date-filter="7days">
                                        üìÖ √öltimos 7 d√≠as
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-movimiento-date-filter="30days">
                                        üìÖ √öltimos 30 d√≠as
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-movimiento-date-filter="90days">
                                        üìÖ √öltimos 90 d√≠as
                                    </button>
                                </div>
                                
                                <!-- Filtro de rango de fechas personalizado -->
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-muted">üìÖ</span>
                                    <input type="date" class="form-control form-control-sm" id="movimientoStartDate" style="width: 140px;">
                                    <span class="text-muted">a</span>
                                    <input type="date" class="form-control form-control-sm" id="movimientoEndDate" style="width: 140px;">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="applyMovimientoDateRange">
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen del Producto -->
                    <div class="row mb-3" id="resumenProducto" style="display: none;">
                        <div class="col-md-4">
                            <div class="card metric-card success h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted mb-1">üì¶ Total Vendido</h6>
                                    <h3 class="mb-0 text-success" id="totalVendido">0</h3>
                                    <small class="text-muted" id="unidadProducto">Unidades</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card metric-card info h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted mb-1">üõí Veces Vendido</h6>
                                    <h3 class="mb-0 text-info" id="vecesVendido">0</h3>
                                    <small class="text-muted">Pedidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card metric-card warning h-100">
                <div class="card-body text-center">
                                    <h6 class="card-title text-muted mb-1">üìä Promedio</h6>
                                    <h3 class="mb-0 text-warning" id="promedioVenta">0</h3>
                                    <small class="text-muted">Por pedido</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenedor de Gr√°ficos de Movimientos -->
                    <div class="row" id="movimientosChartsContainer">
                        <!-- Los gr√°ficos se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts para los gr√°ficos -->
<script src="{% static 'libs/chart.js' %}"></script>
<script src="{% static 'productos_analytics.js' %}"></script>

{% endblock %} 