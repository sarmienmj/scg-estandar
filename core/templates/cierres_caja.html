{% extends 'menu.html' %}
{% load static %}

{% block title %}Cierres de Caja - SCG POS{% endblock title %}

{% block content %}
<style>
  :root {
    --primary-color: #001E62;
    --secondary-color: #418FDE;
    --success-color: #467012;
    --success-hover: #527821;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
  }

  body {
    background-color: var(--light-bg);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  .page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 30, 98, 0.15);
  }

  .page-header h2 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
  }

  .filters-section {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-bottom: 30px;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
  }

  .filter-group label {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .form-control {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .form-control:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.2rem rgba(65, 143, 222, 0.25);
  }

  .btn-filter {
    background: linear-gradient(135deg, var(--success-color), var(--success-hover));
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .btn-filter:hover {
    background: linear-gradient(135deg, var(--success-hover), var(--success-color));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(70, 112, 18, 0.3);
    color: white;
  }

  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
  }

  .table {
    margin: 0;
  }

  .table thead th {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 16px 12px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .table tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid var(--border-color);
  }

  .table tbody tr:hover {
    background-color: rgba(65, 143, 222, 0.05);
    transform: scale(1.01);
  }

  .table tbody td {
    padding: 16px 12px;
    vertical-align: middle;
    border: none;
    font-size: 0.9rem;
  }

  .btn-detail {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    font-size: 0.8rem;
  }

  .btn-detail:hover {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 30, 98, 0.3);
  }

  .text-danger {
    color: var(--danger-color) !important;
    font-weight: 600;
  }

  .text-success {
    color: var(--success-color) !important;
    font-weight: 600;
  }

  .cierre-id {
    font-weight: 600;
    color: var(--primary-color);
    font-family: 'Courier New', monospace;
  }

  .usuario-nombre {
    font-weight: 600;
    color: var(--secondary-color);
  }

  .fecha-info {
    font-size: 0.85rem;
    color: #6c757d;
  }

  .dinero-info {
    font-weight: 600;
    font-family: 'Courier New', monospace;
  }

  .dinero-usd {
    color: var(--success-color);
  }

  .dinero-bs {
    color: var(--warning-color);
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .filters-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }
  }

  @media (max-width: 768px) {
    .main-container {
      padding: 10px;
    }

    .page-header {
      padding: 20px;
      margin-bottom: 20px;
    }

    .page-header h2 {
      font-size: 2rem;
      text-align: center;
    }

    .filters-section {
      padding: 20px;
      margin-bottom: 20px;
    }

    .filters-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .btn-filter {
      width: 100%;
      padding: 15px;
      font-size: 1rem;
    }

    .table-responsive {
      border-radius: 12px;
      overflow: hidden;
    }

    .table thead {
      display: none;
    }

    .table tbody tr {
      display: block;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .table tbody td {
      display: block;
      text-align: left;
      padding: 8px 0;
      border: none;
    }

    .table tbody td:before {
      content: attr(data-label) ": ";
      font-weight: 600;
      color: var(--primary-color);
      min-width: 120px;
      display: inline-block;
    }

    .btn-detail {
      display: block;
      text-align: center;
      margin-top: 10px;
      padding: 12px;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 576px) {
    .page-header h2 {
      font-size: 1.8rem;
    }

    .filters-section {
      padding: 15px;
    }

    .form-control {
      padding: 10px 12px;
    }
  }

  /* Loading state */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--secondary-color);
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="main-container">
  <div class="page-header">
    <h2>üè¶ Cierres de Caja</h2>
  </div>
  
  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="id_cierre">üÜî ID Cierre:</label>
        <input type="number" id="id_cierre" class="form-control" placeholder="ID">
      </div>
      <div class="filter-group">
        <label for="fecha_inicio">üìÖ Fecha Inicio:</label>
        <input type="date" id="fecha_inicio" class="form-control">
      </div>
      <div class="filter-group">
        <label for="fecha_fin">üìÖ Fecha Fin:</label>
        <input type="date" id="fecha_fin" class="form-control">
      </div>
      <div class="filter-group">
        <label for="usuario">üë§ Usuario:</label>
        <select id="usuario" class="form-control">
          <option value="">Todos</option>
          {% for user in usuarios %}
            <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="estado">üìä Estado:</label>
        <select id="estado" class="form-control">
          <option value="todos">Todos</option>
          <option value="abierta">Cajas Abiertas</option>
          <option value="cerrada">Cajas Cerradas</option>
        </select>
      </div>
      <div class="filter-group">
        <button id="filtrar" class="btn btn-filter">
          üîç Filtrar
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Cierres -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>üÜî ID</th>
            <th>üë§ Usuario</th>
            <th>üìÖ Fecha Inicio</th>
            <th>üìÖ Fecha Fin</th>
            <th>üíµ Inicial USD</th>
            <th>üíµ Inicial BS</th>
            <th>üí∞ Final USD</th>
            <th>üí∞ Final BS</th>
            <th>üìä Diferencia USD</th>
            <th>üìä Diferencia BS</th>
            <th>‚öôÔ∏è Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-cierres">
          {% for cierre in cierres %}
          <tr>
            <td data-label="ID" class="cierre-id">{{ cierre.id }}</td>
            <td data-label="Usuario" class="usuario-nombre">{{ cierre.usuario.username }}</td>
            <td data-label="Fecha Inicio" class="fecha-info">{{ cierre.fechaInicio|date:"d/m/Y h:i A" }}</td>
            <td data-label="Fecha Fin" class="fecha-info">{{ cierre.fechaFin|date:"d/m/Y h:i A" }}</td>
            <td data-label="Inicial USD" class="dinero-info dinero-usd">${{ cierre.dinero_inicial_usd|floatformat:2 }}</td>
            <td data-label="Inicial BS" class="dinero-info dinero-bs">Bs. {{ cierre.dinero_inicial_bs|floatformat:2 }}</td>
            <td data-label="Final USD" class="dinero-info dinero-usd">${{ cierre.dinero_final_usd|floatformat:2 }}</td>
            <td data-label="Final BS" class="dinero-info dinero-bs">Bs. {{ cierre.dinero_final_bs|floatformat:2 }}</td>
            <td data-label="Diferencia USD" class="dinero-info {% if cierre.diferencia_usd < 0 %}text-danger{% else %}text-success{% endif %}">
              ${{ cierre.diferencia_usd|floatformat:2 }}
            </td>
            <td data-label="Diferencia BS" class="dinero-info {% if cierre.diferencia_bs < 0 %}text-danger{% else %}text-success{% endif %}">
              Bs. {{ cierre.diferencia_bs|floatformat:2 }}
            </td>
            <td data-label="Acciones">
              <a href="{% url 'pos:detalle-cierre' cierre.id %}" class="btn-detail">
                üìã Ver Detalle
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="{% static 'jquery-3.6.4.js' %}"></script>
<script>
$(document).ready(function() {
    $('#filtrar').click(function() {
        const $btn = $(this);
        const $table = $('#tabla-cierres');
        
        // Add loading state
        $btn.prop('disabled', true).text('‚è≥ Filtrando...');
        $table.addClass('loading');
        
        $.ajax({
            url: '{% url "pos:filtrar-cierres-caja" %}',
            type: 'POST',
            data: {
                'id_cierre': $('#id_cierre').val(),
                'fecha_inicio': $('#fecha_inicio').val(),
                'fecha_fin': $('#fecha_fin').val(),
                'usuario': $('#usuario').val(),
                'estado': $('#estado').val()
            },
            success: function(response) {
                $table.html(response.html);
            },
            error: function(xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
                alert('Error al filtrar los datos. Por favor, int√©ntalo de nuevo.');
            },
            complete: function() {
                // Remove loading state
                $btn.prop('disabled', false).text('üîç Filtrar');
                $table.removeClass('loading');
            }
        });
    });

    // Auto-filter on Enter key
    $('.form-control').keypress(function(e) {
        if (e.which == 13) { // Enter key
            $('#filtrar').click();
        }
    });

    // Clear filters functionality
    function clearFilters() {
        $('#id_cierre').val('');
        $('#fecha_inicio').val('');
        $('#fecha_fin').val('');
        $('#usuario').val('');
        $('#estado').val('todos');
    }

    // Add clear button (optional)
    // $('<button type="button" class="btn btn-secondary ml-2">üóëÔ∏è Limpiar</button>')
    //     .insertAfter('#filtrar')
    //     .click(clearFilters);
});
</script>
{% endblock %} 