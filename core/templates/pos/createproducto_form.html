{%extends 'menu.html'%}

{% block title %}Crear Producto - SCG POS{% endblock title %}

{%block content%}

<style>
  .producto-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .producto-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    box-shadow: 
      0 25px 50px rgba(45, 80, 22, 0.1),
      0 15px 35px rgba(45, 80, 22, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.3);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .producto-card:hover {
    transform: translateY(-5px);
    box-shadow: 
      0 35px 70px rgba(45, 80, 22, 0.15),
      0 20px 45px rgba(45, 80, 22, 0.1);
  }

  .producto-header {
    background: linear-gradient(135deg, #4a7c59 0%, #3e7b27 100%);
    color: white;
    padding: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .producto-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
  }

  .producto-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    z-index: 2;
  }

  .producto-header .icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.9;
    position: relative;
    z-index: 2;
  }

  .producto-body {
    padding: 40px;
  }

  .form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
  }

  .form-row .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  .form-group {
    margin-bottom: 25px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d5016;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-control, .form-select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
    color: #2d5016;
  }

  .form-control:focus, .form-select:focus {
    outline: none;
    border-color: #4a7c59;
    background: rgba(255, 255, 255, 1);
    box-shadow: 
      0 0 0 3px rgba(74, 124, 89, 0.2),
      0 5px 15px rgba(45, 80, 22, 0.1);
    transform: translateY(-1px);
  }

  .image-upload-section {
    border: 2px dashed #4a7c59;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    background: rgba(74, 124, 89, 0.05);
    transition: all 0.3s ease;
    margin-bottom: 25px;
  }

  .image-upload-section:hover {
    border-color: #3e7b27;
    background: rgba(74, 124, 89, 0.1);
  }

  .image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 10px;
    margin: 15px auto;
    display: block;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .upload-icon {
    font-size: 3rem;
    color: #4a7c59;
    margin-bottom: 15px;
  }

  .upload-text {
    color: #2d5016;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .upload-hint {
    color: #6c757d;
    font-size: 0.9rem;
  }

  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    padding: 15px;
    background: rgba(74, 124, 89, 0.05);
    border-radius: 10px;
    border: 2px solid #e0e0e0;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    transition: all 0.3s ease;
  }

  .checkbox-item:hover {
    background: #f8f9fa;
    border-color: #4a7c59;
  }

  .checkbox-item input[type="checkbox"]:checked + label {
    color: #4a7c59;
    font-weight: 600;
  }

  .radio-group {
    display: flex;
    gap: 20px;
    padding: 15px;
    background: rgba(74, 124, 89, 0.05);
    border-radius: 10px;
    border: 2px solid #e0e0e0;
  }

  .radio-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 2px solid #ddd;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .radio-item:hover {
    border-color: #4a7c59;
  }

  .radio-item input[type="radio"]:checked + label {
    color: #4a7c59;
    font-weight: 600;
  }

  .form-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 40px;
  }

  .btn-save {
    background: linear-gradient(135deg, #4a7c59 0%, #3e7b27 100%);
    color: white;
    border: none;
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 20px rgba(45, 80, 22, 0.3);
    min-width: 150px;
  }

  .btn-save:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(45, 80, 22, 0.4);
    background: linear-gradient(135deg, #3e7b27 0%, #2d5016 100%);
  }

  .btn-cancel {
    background: transparent;
    color: #6c757d;
    border: 2px solid #6c757d;
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 150px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-cancel:hover {
    background: #6c757d;
    color: white;
    text-decoration: none;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
  }

  .error-message {
    color: #dc3545;
    font-size: 0.9rem;
    margin-top: 5px;
    padding: 8px 12px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 5px;
    border-left: 3px solid #dc3545;
  }
</style>

<div class="producto-container">
  <div class="producto-card">
    <div class="producto-header">
      <div class="icon">📦</div>
      <h2>Crear Nuevo Producto</h2>
    </div>
    
    <div class="producto-body">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        
        <!-- Mostrar errores generales -->
        {% if form.non_field_errors %}
          <div class="error-message">
            {{ form.non_field_errors }}
          </div>
        {% endif %}
        
        <!-- Nombre del producto -->
        <div class="form-group">
          <label class="form-label" for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
          {{ form.nombre }}
          {% if form.nombre.errors %}
            <div class="error-message">{{ form.nombre.errors }}</div>
          {% endif %}
        </div>
        
        <!-- Imagen del producto -->
        <div class="form-group">
          <label class="form-label">Imagen del Producto</label>
          <div class="image-upload-section">
            <div class="upload-icon">📷</div>
            <div class="upload-text">Seleccionar imagen del producto</div>
            <div class="upload-hint">Formatos soportados: JPG, PNG, GIF (máx. 5MB)</div>
            {{ form.imagen }}
            <div id="image-preview-container" style="display: none;">
              <img id="image-preview" class="image-preview" src="" alt="Vista previa">
            </div>
          </div>
          {% if form.imagen.errors %}
            <div class="error-message">{{ form.imagen.errors }}</div>
          {% endif %}
        </div>
        
        <!-- Fila: Cantidad y Unidad -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="{{ form.cantidad.id_for_label }}">{{ form.cantidad.label }}</label>
            {{ form.cantidad }}
            {% if form.cantidad.errors %}
              <div class="error-message">{{ form.cantidad.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label" for="{{ form.unidad.id_for_label }}">{{ form.unidad.label }}</label>
            {{ form.unidad }}
            {% if form.unidad.errors %}
              <div class="error-message">{{ form.unidad.errors }}</div>
            {% endif %}
          </div>
        </div>
        
        <!-- Fila: Moneda y Código de barras -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="{{ form.moneda.id_for_label }}">{{ form.moneda.label }}</label>
            {{ form.moneda }}
            {% if form.moneda.errors %}
              <div class="error-message">{{ form.moneda.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label" for="{{ form.barcode.id_for_label }}">{{ form.barcode.label }}</label>
            {{ form.barcode }}
            {% if form.barcode.errors %}
              <div class="error-message">{{ form.barcode.errors }}</div>
            {% endif %}
          </div>
        </div>
        
        <!-- Fila: Precios -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="{{ form.costo.id_for_label }}">{{ form.costo.label }}</label>
            {{ form.costo }}
            {% if form.costo.errors %}
              <div class="error-message">{{ form.costo.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label" for="{{ form.precio_detal.id_for_label }}">{{ form.precio_detal.label }}</label>
            {{ form.precio_detal }}
            {% if form.precio_detal.errors %}
              <div class="error-message">{{ form.precio_detal.errors }}</div>
            {% endif %}
          </div>
        </div>
        
        <!-- Categorías -->
        <div class="form-group">
          <label class="form-label">{{ form.categoria.label }}</label>
          <div class="checkbox-group">
            {% for choice in form.categoria %}
              <div class="checkbox-item">
                {{ choice.tag }}
                <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
              </div>
            {% endfor %}
          </div>
          {% if form.categoria.errors %}
            <div class="error-message">{{ form.categoria.errors }}</div>
          {% endif %}
        </div>
        
        <!-- Fila: Subproducto y Relación -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="{{ form.subproducto.id_for_label }}">{{ form.subproducto.label }}</label>
            {{ form.subproducto }}
            {% if form.subproducto.errors %}
              <div class="error-message">{{ form.subproducto.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label" for="{{ form.relacion_subproducto.id_for_label }}">{{ form.relacion_subproducto.label }}</label>
            {{ form.relacion_subproducto }}
            {% if form.relacion_subproducto.errors %}
              <div class="error-message">{{ form.relacion_subproducto.errors }}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="form-buttons">
          <button type="submit" class="btn-save">
            <i class="fas fa-save me-2"></i>
            Guardar Producto
          </button>
          <a href="{% url 'pos:productos' %}" class="btn-cancel">
            <i class="fas fa-times me-2"></i>
            Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview de imagen
    const imageInput = document.getElementById('{{ form.imagen.id_for_label }}');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImage = document.getElementById('image-preview');
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        });
    }

    // Bloquear el carácter "-" en todos los campos excepto el campo cantidad
    const allInputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea');
    const cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}');
    
    allInputs.forEach(input => {
        // Permitir "-" solo en el campo cantidad
        if (input === cantidadInput) {
            return;
        }
        
        input.addEventListener('keypress', function(e) {
            if (e.key === '-') {
                e.preventDefault();
                return false;
            }
        });
        
        // También prevenir al pegar
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const cleanedText = pastedText.replace(/-/g, '');
            document.execCommand('insertText', false, cleanedText);
        });
    });

    // Validación del formulario antes de enviar
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}');
            
            // Validar que cantidad no esté vacía
            if (!cantidadInput.value || cantidadInput.value.trim() === '') {
                e.preventDefault();
                alert('⚠️ El campo Cantidad es obligatorio. Por favor, ingrese una cantidad válida.');
                cantidadInput.focus();
                return false;
            }
            
            // Validar que cantidad sea numérica
            const cantidadValue = parseFloat(cantidadInput.value);
            if (isNaN(cantidadValue)) {
                e.preventDefault();
                alert('⚠️ El campo Cantidad debe ser un valor numérico.');
                cantidadInput.focus();
                return false;
            }
        });
    }
    
    // Hacer el campo cantidad obligatorio visualmente
    const cantidadLabel = document.querySelector('label[for="{{ form.cantidad.id_for_label }}"]');
    if (cantidadLabel && !cantidadLabel.querySelector('.required-asterisk')) {
        const asterisk = document.createElement('span');
        asterisk.className = 'required-asterisk';
        asterisk.style.color = 'red';
        asterisk.style.marginLeft = '5px';
        asterisk.textContent = '*';
        cantidadLabel.appendChild(asterisk);
    }
});
</script>

{%endblock content%}