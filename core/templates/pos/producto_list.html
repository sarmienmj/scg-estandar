{% extends 'menu.html' %}
{% load static %}

{% block title %}Gestión de Productos - SCG POS{% endblock title %}

{% block content %}
<!-- Incluir CSS específico para productos -->
<link rel="stylesheet" href="{% static 'productos.css' %}">
<link rel="stylesheet" href="{% static 'styles.css' %}">
<style>
  /* Quitar animaciones de inicio */
  .productos-container {
    animation: none !important;
  }
  .productos-container > * {
    animation: none !important;
  }
</style>

<div class="productos-container">
  <!-- Header Section -->
  <div class="productos-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="productos-title">
            <i class="fas fa-box me-3"></i>Gestión de Productos
          </h1>
          <p class="productos-subtitle">
            Administra tu inventario de productos de manera eficiente
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <button type="button" id="boton-crear-producto" class="btn btn-success-custom">
            <i class="fas fa-plus me-2"></i>Crear Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Search Controls -->
    <div class="search-controls">
      <div class="row search-row">
        <div class="col-lg-3 col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" class="form-control form-control-custom" 
                   id="buscar-producto-nombre-list" 
                   placeholder="Buscar por nombre...">
          </div>
        </div>
        <div class="col-lg-2 col-md-6">
          <button id="buscar-producto-nombre-btn" type="button" class="btn btn-primary-custom w-100">
            <i class="fas fa-search me-2"></i>Buscar
          </button>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-barcode"></i>
            </span>
            <input type="text" class="form-control form-control-custom" 
                   id="buscar-producto-id-list" 
                   placeholder="Buscar por código o barcode...">
          </div>
        </div>
        <div class="col-lg-2 col-md-6">
          <button id="buscar-producto-id-btn" type="button" class="btn btn-primary-custom w-100">
            <i class="fas fa-search me-2"></i>Buscar
          </button>
        </div>
        <div class="col-lg-2 col-md-12">
          <button type="button" class="btn btn-success-custom w-100" onclick="location.reload()">
            <i class="fas fa-sync-alt me-2"></i>Refrescar
          </button>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <div class="products-table-container">
      <div class="table-header">
        <h3 class="mb-0">
          <i class="fas fa-list me-2"></i>Lista de Productos
        </h3>
      </div>
      
      <div class="table-responsive-custom">
        {% if productos_list %}
          <table class="table table-custom">
            <thead>
              <tr>
                <th scope="col">#ID</th>
                <th scope="col">Nombre</th>
                <th scope="col">Cantidad</th>
                <th scope="col">Unidad</th>
                <th scope="col">Costo</th>
                <th scope="col">Precio Detal</th>
                <th scope="col">Categoría</th>
                <th scope="col" class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-productos-menu">
              {% for producto in productos_list %}
              <tr>
                <td class="product-id">#{{ producto.pk }}</td>
                <td class="product-name">{{ producto.nombre }}</td>
                <td class="product-quantity">
                  {% if producto.cantidad_formateada %}
                    {{ producto.cantidad_formateada }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-secondary">{{ producto.unidad }}</span>
                </td>
                <td class="product-price">
                  {% if producto.costo %}
                    ${{ producto.costo }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="product-price">
                  {% if producto.moneda == 'USD' %}
                    ${{ producto.precio_detal }} <span class="badge bg-success">USD</span>
                  {% else %}
                    {{ producto.precio_detal }} Bs. <span class="badge bg-primary">BS</span>
                  {% endif %}
                </td>
                <td class="product-category">
                  {% for categoria in producto.categoria.all %}
                    <span class="badge bg-info me-1">{{ categoria.nombre }}</span>
                  {% empty %}
                    <span class="badge bg-light text-dark">Sin categoría</span>
                  {% endfor %}
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <a href="edit/{{ producto.pk }}" class="btn btn-action btn-edit me-1" 
                       title="Modificar producto">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="cantidad/{{ producto.pk }}" class="btn btn-action btn-quantity me-1" 
                       title="Ajustar cantidad">
                      <i class="fas fa-plus-minus"></i>
                    </a>
                    <form method="post" action="delete/{{ producto.pk }}" 
                          style="display: inline;" 
                          onsubmit="return confirm('¿Estás seguro de que quieres eliminar este producto?')">
                      <button type="submit" class="btn btn-action btn-delete" 
                              title="Eliminar producto">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h4>No hay productos registrados</h4>
            <p>Comienza creando tu primer producto para gestionar tu inventario.</p>
            <button type="button" id="boton-crear-producto-empty" class="btn btn-success-custom">
              <i class="fas fa-plus me-2"></i>Crear Primer Producto
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Hidden URLs -->
<p id="crear-producto-url" class="invisible">{% url 'pos:crear-producto' %}</p>

<script>
  // Make both create buttons work
  document.getElementById('boton-crear-producto').addEventListener('click', function() {
    window.location.href = document.getElementById('crear-producto-url').textContent;
  });
  
  if (document.getElementById('boton-crear-producto-empty')) {
    document.getElementById('boton-crear-producto-empty').addEventListener('click', function() {
      window.location.href = document.getElementById('crear-producto-url').textContent;
    });
  }

  // Add search functionality with Enter key
  document.getElementById('buscar-producto-nombre-list').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('buscar-producto-nombre-btn').click();
    }
  });

  document.getElementById('buscar-producto-id-list').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('buscar-producto-id-btn').click();
    }
  });

  // Add loading states to buttons
  function addLoadingState(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';
      button.disabled = true;
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
    }
  }

  // Add click handlers for loading states
  document.getElementById('buscar-producto-nombre-btn').addEventListener('click', function() {
    addLoadingState('buscar-producto-nombre-btn');
  });

  document.getElementById('buscar-producto-id-btn').addEventListener('click', function() {
    addLoadingState('buscar-producto-id-btn');
  });

  // Add tooltip functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
  });

  // Add smooth scrolling for better UX
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }

  // Add scroll to top when searching
  document.getElementById('buscar-producto-nombre-btn').addEventListener('click', scrollToTop);
  document.getElementById('buscar-producto-id-btn').addEventListener('click', scrollToTop);
</script>
{% endblock %}